name: Prod CI/CD

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Permitir ejecuciÃ³n manual

env:
  SUPABASE_PROJECT_REF: hqdatzhliaordlsqtjea

jobs:
  migrate-db:
    name: ğŸ”„ Apply Database Migrations
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v5

      - name: ğŸ“¦ Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: ğŸ”— Link Supabase project
        run: supabase link --project-ref ${{ env.SUPABASE_PROJECT_REF }} || echo "âš ï¸ Link failed"
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        continue-on-error: true
        timeout-minutes: 2  # Timeout despuÃ©s de 2 minutos

      - name: ğŸ“‹ List pending migrations
        run: |
          echo "ğŸ“‹ Checking migrations..."
          supabase migration list --linked || echo "âš ï¸ Could not list migrations (may need token)"

      - name: ğŸš€ Apply pending migrations (prod)
        run: supabase db push --linked || echo "âš ï¸ Migration push failed or no migrations to apply"
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        continue-on-error: true  # No bloquear workflow si migraciones fallan
        timeout-minutes: 5  # Timeout despuÃ©s de 5 minutos

      - name: âœ… Verify migrations applied
        run: |
          echo "âœ… Migrations applied successfully"
          supabase migration list --linked || echo "âš ï¸ Could not verify (non-blocking)"

      - name: ğŸ”” Notify migration success
        if: success()
        run: echo "âœ… Database migrations completed successfully"

      - name: ğŸš¨ Notify migration failure
        if: failure()
        run: |
          echo "âŒ Database migrations failed!"
          echo "âš ï¸ Deployment to Vercel will NOT proceed"
          exit 1

  deploy-vercel:
    name: ğŸš€ Deploy to Vercel
    runs-on: ubuntu-latest
    needs: migrate-db  # Solo ejecuta si migraciones fueron exitosas
    if: success()  # Solo si migrate-db fue exitoso
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v5

      - name: ğŸ”” Trigger Vercel Deploy Hook (production)
        continue-on-error: true  # No fallar si hook falla
        run: |
          if [ -z "${{ secrets.VERCEL_DEPLOY_HOOK_PROD }}" ]; then
            echo "âš ï¸ VERCEL_DEPLOY_HOOK_PROD not set - skipping deploy hook"
            echo "â„¹ï¸ Vercel will deploy automatically from git push"
            exit 0
          fi
          echo "ğŸš€ Triggering Vercel deployment..."
          curl -X POST "${{ secrets.VERCEL_DEPLOY_HOOK_PROD }}" || echo "âš ï¸ Deploy hook failed (non-blocking)"
          echo "âœ… Deploy hook triggered"

      - name: âœ… Deployment initiated
        if: success()
        run: echo "âœ… Vercel deployment triggered successfully"

      - name: ğŸš¨ Deployment hook failed
        if: failure()
        run: |
          echo "âš ï¸ Deploy hook failed (non-blocking)"
          echo "â„¹ï¸ Vercel will deploy automatically from git push"


